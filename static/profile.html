<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Profile - Agri360</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .profile-card{max-width:900px;margin:28px auto;padding:22px;background:var(--surface);border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06);color:var(--text)}
    .profile-header{display:flex;align-items:center;gap:16px}
    .profile-avatar{width:64px;height:64px;border-radius:50%;background:rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;color:var(--text);font-weight:700}
    table.orders{width:100%;border-collapse:collapse;margin-top:18px}
    table.orders th, table.orders td{padding:8px 10px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left;color:var(--text)}
    body.dark-mode .profile-card{ background: rgba(255,255,255,0.02); box-shadow: none }
    body.dark-mode .profile-avatar{ background: rgba(255,255,255,0.02); color: var(--text) }
  </style>
</head>
<body>
<script src="/theme.js"></script>

<div id="site-header-placeholder"></div>
<script src="/header.js"></script>

<div class="profile-card">
  <div class="profile-header">
    <div class="profile-avatar">U</div>
    <div>
      <h2 id="email">User</h2>
      <div id="ordersCount" class="muted"></div>
    </div>
  </div>

  <h3 style="margin-top:18px">Orders</h3>
  <div id="ordersArea">Loading orders...</div>
</div>

<script>
async function loadProfile(){
  try{
    const u = await (await fetch('/api/user')).json();
    if(!u.logged){ document.getElementById('email').innerText='Not logged in'; document.getElementById('ordersArea').innerHTML='Please login to see orders.'; return }
    document.getElementById('email').innerText = u.user.email;
    document.getElementById('ordersCount').innerText = (u.orders_count || 0) + ' orders';

    // fetch orders
    const ro = await (await fetch('/api/orders', {credentials:'same-origin'})).json();
    if(!ro.success){ document.getElementById('ordersArea').innerHTML='Could not load orders'; return }
    const orders = ro.orders || [];
    if(!orders.length){ document.getElementById('ordersArea').innerHTML='<div class="muted">No orders found.</div>'; return }

    let html = '<table class="orders"><thead><tr><th>ID</th><th>Type</th><th>Product</th><th>Qty</th><th>Price</th><th>Placed</th></tr></thead><tbody>';
    html += orders.map(o=>`<tr><td>${o.id}</td><td>${o.type}</td><td>${o.product}</td><td>${o.quantity}</td><td>${o.price}</td><td>${new Date(o.timestamp*1000).toLocaleString()}</td></tr>`).join('');
    html += '</tbody></table>';
    document.getElementById('ordersArea').innerHTML = html;
  }catch(e){ document.getElementById('ordersArea').innerHTML='Error loading profile'; console.error(e) }
}
loadProfile();
</script>

</body>
</html>